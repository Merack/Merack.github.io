<!DOCTYPE html><html lang="en-gb"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>WordPress 安全防护简单记录 - Merack&#x27;s Home</title><meta name="description" content="WordPress网站一直是被恶意程序扫描和密码爆破的重灾区, 每次一查Nginx日志都能看到一大堆对本博客的密码撞库攻击和敏感路径扫描 在几年前由于用了弱密码还真被爆破成功, 虽然很快我就改了密码. 但由于不确定是否有被留下暗桩, 索性重装了一遍系统, 都是血泪教训. 随着跑在服务器上的业务越来越多, 重装的代价已经是非常大了. 所以从那次事故以后我便开始留意WordPress的安全问题,&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://blog.merack.top/wordpress-an-quan-fang-hu-jian-dan-ji-lu.html"><link rel="alternate" type="application/atom+xml" href="https://blog.merack.top/feed.xml"><link rel="alternate" type="application/json" href="https://blog.merack.top/feed.json"><link rel="shortcut icon" href="https://blog.merack.top/media/website/favicon-16x16.png" type="image/png"><link rel="stylesheet" href="https://blog.merack.top/assets/css/style.css"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.merack.top/wordpress-an-quan-fang-hu-jian-dan-ji-lu.html"},"headline":"WordPress 安全防护简单记录","datePublished":"2024-12-03T16:08+08:00","dateModified":"2024-12-05T12:03+08:00","description":"WordPress网站一直是被恶意程序扫描和密码爆破的重灾区, 每次一查Nginx日志都能看到一大堆对本博客的密码撞库攻击和敏感路径扫描 在几年前由于用了弱密码还真被爆破成功, 虽然很快我就改了密码. 但由于不确定是否有被留下暗桩, 索性重装了一遍系统, 都是血泪教训. 随着跑在服务器上的业务越来越多, 重装的代价已经是非常大了. 所以从那次事故以后我便开始留意WordPress的安全问题,&hellip;","author":{"@type":"Person","name":"Merack","url":"https://blog.merack.top/authors/merack/"},"publisher":{"@type":"Organization","name":"Merack"}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript></head><body class="post-template"><header class="top js-header"><a class="logo" href="https://blog.merack.top/">Merack&#x27;s Home</a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://blog.merack.top/about.html" target="_self">About</a></li></ul></nav></header><main class="post"><article class="content"><div class="hero hero--noimage"><header class="hero__content"><div class="wrapper"><h1>WordPress 安全防护简单记录</h1><div class="feed__meta content__meta"><img src="https://blog.merack.top/media/website/qbanjinmuyan_Kan-Tu-Wang.web-2.png" loading="eager" height="500" width="458" class="feed__author-thumb" alt="Merack"> <a href="https://blog.merack.top/authors/merack/" class="feed__author">Merack</a> <time datetime="2024-12-03T16:08" class="feed__date">December 3, 2024</time></div></div></header></div><div class="entry-wrapper content__entry"><figure class="alignnone size-full wp-image-90">WordPress网站一直是被恶意程序扫描和密码爆破的重灾区, 每次一查Nginx日志都能看到一大堆对本博客的密码撞库攻击和敏感路径扫描 <a href="https://cdn.merack.top/wp-content/uploads/2024/12/9b08f457-b2a4-5f21-d949-5a2b0acc872d.png"><img src="https://cdn.merack.top/wp-content/uploads/2024/12/9b08f457-b2a4-5f21-d949-5a2b0acc872d.png" alt="" width="788" height="323" data-is-external-image="true"></a></figure><a href="https://cdn.merack.top/wp-content/uploads/2024/12/5486867a-cf9d-feff-1934-2d0d6466e649.png"><figure class="alignnone size-full wp-image-86"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2024/12/5486867a-cf9d-feff-1934-2d0d6466e649.png" alt="" width="1908" height="796" data-is-external-image="true"></figure></a>在几年前由于用了弱密码还真被爆破成功, 虽然很快我就改了密码. 但由于不确定是否有被留下暗桩, 索性重装了一遍系统, 都是血泪教训. 随着跑在服务器上的业务越来越多, 重装的代价已经是非常大了. 所以从那次事故以后我便开始留意WordPress的安全问题, 下面是我这些年来做过的配置的一些简单记录.<p></p><h2>1. WordPress插件篇</h2><figure class="alignnone size-full wp-image-87">WordPress推荐使用插件 <a href="https://cn.wordpress.org/plugins/login-lockdown/">Login Lockdow</a> 的登录验证码功能, 类型直接选择built-in Captcha即刻, 亲测可以抵挡99%的密码撞库攻击 <a href="https://cdn.merack.top/wp-content/uploads/2024/12/76a96c65-1ce4-0d1a-246e-195ccd5196d2.png"><img src="https://cdn.merack.top/wp-content/uploads/2024/12/76a96c65-1ce4-0d1a-246e-195ccd5196d2.png" alt="" width="1465" height="688" data-is-external-image="true"></a></figure>可以看到登录失败的全是给验证码拦截了 <a href="https://cdn.merack.top/wp-content/uploads/2024/12/728b31a3-18d1-60cc-e079-6f9595280706.png"><figure class="alignnone size-full wp-image-88"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2024/12/728b31a3-18d1-60cc-e079-6f9595280706.png" alt="" width="1504" height="598" data-is-external-image="true"></figure></a>WordPress上还有很多更加全面的安全插件, 但过多或者过于复杂的插件会减慢站点速度, 特别是我现在用这个小鸡性能一般, 因此我会更倾向在下面几个方面来做后续的防护.<p></p><h2>2.Nginx篇</h2><p>在Nginx上我主要是对WordPress中的一些敏感路径进行访问限制, 主要配置如下</p><div><pre>   #禁止以. 开头的文件访问, 如.htaccess, .htpasswd, .DS_Store (Mac).
    location ~ /\. {
        deny all;
    }

    #禁止访问路径 /xmlrpc.php
    location ~ /xmlrpc.php$ {
        deny all;
    }

    #禁止访问路径 /wp-json/wp/v2/users
    location ~ ^/wp-json/wp/v2/users {
        deny all;
    }

    #禁止访问路径 /wp-includes/wlwmanifest.xml
    location ~ ^/wp-includes/wlwmanifest.xml {
        deny all;
    }

    #禁止直接访问uploads和files文件夹下的php文件
    location ~ /(?:uploads|files)/.*\.php$ {
        deny all;
    }</pre></div><div>其中<code>/xmlrpc.php</code>是除了/wp-login.php 之外的另一种可以被用来验证后台密码的方式, 因此也经常会被利用来做密码撞库;</div><div><code>/wp-json/wp/v2/users</code> 会返回后台管理员的登录用户名, 建议禁止并且不要将管理员登录名设置成Admin这种常见的形式;</div><div><code>/wp-includes/wlwmanifest.xml</code> 是我在别的博客看到的, 但是新版WordPress好像移除了这个文件, 反正我用的版本目录下没有, 关于这个文件的限制可以不写, 最重要的还是前面两个路径.</div><h2>3.CDN篇</h2><p>如果你的网站套了CDN的话, 可以通过CDN里提供的一些配置来相关的防护. 不同CDN提供商的功能都有所不同, 这里我主要记录我正在用的两家CDN的配置.</p><h3>3.1 又拍云</h3><figure class="alignnone size-full wp-image-89">在CDN的访问控制选项下又拍云提供了网站安全防护的基本功能, 我主要用到的是 IP 访问限制 和 WAF保护 这两个. ip访问限制可以对敏感路径设置一个阈值, 如果某个ip在短时间内对该路径的请求超过该阈值, 那么它可能是在做密码撞库, 这时就会禁止他的访问请求. 我的配置如下 <a href="https://cdn.merack.top/wp-content/uploads/2024/12/b671f607-2ba8-fac4-b8a3-6bfcadeb8430.png"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2024/12/b671f607-2ba8-fac4-b8a3-6bfcadeb8430.png" alt="" width="1373" height="392" data-is-external-image="true"></a></figure>我的阈值设置成20次/分, 封禁时间是8400秒, 可以多观察网站的访问日志, 根据自己的情况来设置. 建议在上方的ip白名单中加入自己的ip防止误杀.<p></p><p>此外, 又拍云还提供了 WAF保护, 但是只有一个功能开关, 不能配置规则, 也没有分析统计, 在这方面不如Cloudflare. 这项配置没什么好说的, 打开就好.</p><h3>3.2 Cloudflare</h3><p>相较于又拍云, Cloudflare提供的安全防护就全面了很多. 提供了WAF, DDoS防护, 页面规则等一系列功能, 其中WAF是可以自己写规则的, 可以说是非常丰富了. 我在Cloudflare上的安全配置基本都是在WAF里, 下面是我写的一些规则:</p><p><strong>第一条</strong>是专门为WordPress写的, 一是阻止WordPress的敏感路径扫描,二是阻止规定以外的ip进行登录请求</p><pre>(http.host wildcard "merack.top") and ((cf.waf.credential_check.password_leaked) or (http.request.uri.path wildcard r"/wp-login.php" and (ip.geoip.country ne "CN" and (not ip.src in {192.168.1.1}))) or ((http.request.uri.path wildcard r"/xmlrpc.php") or (http.request.uri.path wildcard r"/wp-json/wp/v2/users"))) 
</pre><p><code>http.host wildcard "merack.top"</code> 表示只匹配对merack.top的访问;</p><p><code>cf.waf.credential_check.password_leaked</code> 表示cf会检测登录请求中的密码是否是已知的通过各种信息泄露事件泄露过的密码, 具体描述可以看Cloudflare官方的这篇文档, 不少自动程序除了尝试弱密码组合之外还会尝试泄露过的数据库中的密码; http.request.uri.path wildcard r"/wp-login.php" 表示匹配访问路径是/wp-login.php的请求;</p><p><code>ip.geoip.country ne "CN" and (not ip.src in {192.168.1.1})</code> 表示匹配请求ip不是来自中国的并且不在受信任ip里的(这里以192.168.1.1)为例, 建议将正在托管WordPress的服务器ip加入到列表中, 因为通过Nginx日志观察, WordPress会定时请求自身来触发一些定时任务(比如/wp-login.php), 如果你的服务器ip恰好不在中国内又不在信任ip列表中, 那么可能会被拦截, 也可以在这条waf规则前再写一条白名单规则放行; </p><p><code>(http.request.uri.path wildcard r"/xmlrpc.php") or (http.request.uri.path wildcard r"/wp-json/wp/v2/users")</code> 表示匹配这两个敏感路径的请求, 这两个路径在前面已经做过介绍.</p><p>最后将这几个匹配条件按照相应的逻辑通过and 和 or 连接起来, 大概如下图</p><figure class="alignnone size-full wp-image-91"><a href="https://cdn.merack.top/wp-content/uploads/2024/12/e024a11d-1bc1-49c0-2ce5-b9c820a969a6.png" style="font-family: var(--editor-font-family); font-size: inherit; font-weight: var(--font-weight-normal);"><img src="https://cdn.merack.top/wp-content/uploads/2024/12/e024a11d-1bc1-49c0-2ce5-b9c820a969a6.png" alt="" width="1345" height="680" data-is-external-image="true"></a></figure><span style="color: var(--text-primary-color); font-family: var(--editor-font-family); font-size: inherit; font-weight: var(--font-weight-normal);">效果还是很可观的 </span><a href="https://cdn.merack.top/wp-content/uploads/2024/12/2b48a6ef-e98f-d323-caa8-b18f104aa1c3.png" style="font-family: var(--editor-font-family); font-size: inherit; font-weight: var(--font-weight-normal);"><figure class="alignnone size-full wp-image-92"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2024/12/2b48a6ef-e98f-d323-caa8-b18f104aa1c3.png" alt="" width="1252" height="724" data-is-external-image="true"></figure></a><span style="color: var(--text-primary-color); font-family: var(--editor-font-family); font-size: inherit; font-weight: var(--font-weight-normal);"></span><p></p><figure class="alignnone size-full wp-image-94"><strong style="font-family: var(--editor-font-family); font-size: inherit;">第二条</strong><span style="color: var(--text-primary-color); font-family: var(--editor-font-family); font-size: inherit; font-weight: var(--font-weight-normal);">规则是对域名下的所有站点都生效的, 主要是防止除了已知的搜索引擎的蜘蛛机器人之外的其他自动程序和高风险IP对站点进行扫描, 这里的逻辑比较简单, 直接用可视化的表达式生成器即可: </span><a href="https://cdn.merack.top/wp-content/uploads/2024/12/3707771e-3617-5d48-49a0-1bb4679e2e2b.png" style="font-family: var(--editor-font-family); font-size: inherit; font-weight: var(--font-weight-normal);"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2024/12/3707771e-3617-5d48-49a0-1bb4679e2e2b.png" alt="" width="1329" height="774" data-is-external-image="true"></a></figure><span style="color: var(--text-primary-color); font-family: var(--editor-font-family); font-size: inherit; font-weight: var(--font-weight-normal);">与第一条规则不同, 这里没有指定 </span><code style="font-weight: var(--font-weight-normal);">http.host wildcard "merack.top"</code><span style="color: var(--text-primary-color); font-family: var(--editor-font-family); font-size: inherit; font-weight: var(--font-weight-normal);"> , 所以该条规则对域名下的所有子域名都有效.</span><p></p><p><span style="color: var(--text-primary-color); font-family: var(--editor-font-family); font-size: inherit; font-weight: var(--font-weight-normal);">图中的威胁分数是Cloudflare对ip的恶意程度进行的一个评估, 请求的威胁评分值为0到100, 其中0表示低风险. 大于10的值可能表示垃圾邮件发送者或机器人, 大于40的值表示互联网上的不良行为者, 很少有超过60的值. 详细描述可以参照官方的</span><a href="https://developers.cloudflare.com/ruleset-engine/rules-language/fields/dynamic-fields/#cfthreat_score" style="font-family: var(--editor-font-family); font-size: inherit; font-weight: var(--font-weight-normal);">这个文档</a><span style="color: var(--text-primary-color); font-family: var(--editor-font-family); font-size: inherit; font-weight: var(--font-weight-normal);">.官方推荐设置大于10触发托管质询, 大于50直接block.</span></p><p><span style="color: var(--text-primary-color); font-family: var(--editor-font-family); font-size: inherit; font-weight: var(--font-weight-normal);">下面的选择操作-&gt;托管质询 是指Cloudflare会生成一个用于人机验证的验证页面, 通过验证才可以继续访问.</span></p><figure class="alignnone size-full wp-image-95"><span style="color: var(--text-primary-color); font-family: var(--editor-font-family); font-size: inherit; font-weight: var(--font-weight-normal);">最后的规则总览 </span><a href="https://cdn.merack.top/wp-content/uploads/2024/12/8dfc073c-61b8-c22e-5218-f564ac2b3580.png" style="font-family: var(--editor-font-family); font-size: inherit; font-weight: var(--font-weight-normal);"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2024/12/8dfc073c-61b8-c22e-5218-f564ac2b3580.png" alt="" width="1341" height="573" data-is-external-image="true"></a></figure><span style="color: var(--text-primary-color); font-family: var(--editor-font-family); font-size: inherit; font-weight: var(--font-weight-normal);">执行质询类的操作都会自动计算一个CRS值, 这个值可以体现质询规则的有效性, 越低表示误杀的真实用户越少, 则效果越好.<br>如果在CSR为0的同时Nginx日志中还有大量的路径扫描请求记录, 那么可以尝试降低威胁分数的值, 也有可能是这些IP未被收录在Cloudflare的数据库中所以不触发质询, 总之这个要慢慢调, 防扫描我还在学习中. 这条规则我也是刚写等待后面的测试.</span><p></p></div><footer class="content__footer"><div class="entry-wrapper"><div class="content__actions"></div></div><nav class="content__nav"><div class="wrapper"><div class="content__nav-inner"><div class="content__nav-prev"><a href="https://blog.merack.top/shi-yong-you-pai-yun-jia-su-wordpresshou-tai-yang-shi-shi-xiao-hou-tai-cai-dan-gong-neng-dian-ji-wu-fan-ying-jie-jue-fang-fa-ji-jian-yao-pei-zhi.html" class="content__nav-link" rel="prev"><div><span>Previous</span> 使用又拍云加速WordPress简要配置, 解决后台样式失效, 后台功能点击无反应问题</div></a></div><div class="content__nav-next"><a href="https://blog.merack.top/windowsmingw-w64lsp-clangdvscodesublime-pei-zhi-jian-dan-ccpp-dan-wen-jian-xue-xi-huan-jing-jian-yao-ji-lu.html" class="content__nav-link" rel="next"><div><span>Next</span> Windows+MinGW-w64+lsp-clangd+VSCode/sublime 配置简单c/cpp 单文件学习环境简要记录</div></a></div></div></div></nav></footer></article></main><footer class="footer"><div class="wrapper"><div class="footer__copyright"><p>Powered by Publii</p><div style="flex; align-items: center; justify-content: center;"><a href="https://cloudflare.com/"><img src="https://cdn.merack.top/wp-content/uploads/2024/12/ae2e8d68-158b-1842-fc34-0ebcc1365d6c.png" alt="cloudflare"> </a><a href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral"><img style="margin-right: 1px; vertical-align: middle;" src="https://cdn.merack.top/wp-content/uploads/2024/12/8a9de8d6-7a3c-e553-b074-cf653f15d712.png" alt="upyun"> </a><a href="https://cloudflare.com/">提供CDN服务</a></div></div><button onclick="backToTopFunction()" id="backToTop" class="footer__bttop" aria-label="Back to top" title="Back to top"><svg width="20" height="20"><use xlink:href="https://blog.merack.top/assets/svg/svg-map.svg#toparrow"/></svg></button></div></footer><script defer="defer" src="https://blog.merack.top/assets/js/scripts.min.js"></script><script>window.publiiThemeMenuConfig={mobileMenuMode:'overlay',animationSpeed:300,submenuWidth: 'auto',doubleClickTime:500,mobileMenuExpandableSubmenus:true,relatedContainerForOverlayMenuSelector:'.top'};</script><script>var images = document.querySelectorAll('img[loading]');
        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script></body></html>