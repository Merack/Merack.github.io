<!DOCTYPE html><html lang="en-gb"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>无需公网IP: 通过Cloudflare Tunnels实现SSH安全内网穿透 - Merack&#x27;s Home</title><meta name="description" content="大善人Cloudflare在zero trust的网络里提供了一个叫做Tunnels的东西, 通过它可以很轻松地建立多条连接到cloudflare 网络的隧道. Tunnels提供了多种常见协议支持, 比如HTTP, HTTPS, TCP, SSH, RDP,&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://blog.merack.top/wu-xu-gong-wang-ip-tong-guo-cloudflare-tunnelsshi-xian-sshan-quan-nei-wang-chuan-tou.html"><link rel="alternate" type="application/atom+xml" href="https://blog.merack.top/feed.xml" title="Merack&#x27;s Home - RSS"><link rel="alternate" type="application/json" href="https://blog.merack.top/feed.json" title="Merack&#x27;s Home - JSON"><link rel="shortcut icon" href="https://blog.merack.top/media/website/favicon-16x16.png" type="image/png"><link rel="stylesheet" href="https://blog.merack.top/assets/css/style.css"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.merack.top/wu-xu-gong-wang-ip-tong-guo-cloudflare-tunnelsshi-xian-sshan-quan-nei-wang-chuan-tou.html"},"headline":"无需公网IP: 通过Cloudflare Tunnels实现SSH安全内网穿透","datePublished":"2025-02-28T23:58+08:00","dateModified":"2025-02-28T23:58+08:00","description":"大善人Cloudflare在zero trust的网络里提供了一个叫做Tunnels的东西, 通过它可以很轻松地建立多条连接到cloudflare 网络的隧道. Tunnels提供了多种常见协议支持, 比如HTTP, HTTPS, TCP, SSH, RDP,&hellip;","author":{"@type":"Person","name":"Merack","url":"https://blog.merack.top/authors/merack/"},"publisher":{"@type":"Organization","name":"Merack"}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript></head><body class="post-template"><header class="top js-header"><a class="logo" href="https://blog.merack.top/">Merack&#x27;s Home</a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://blog.merack.top/about.html" target="_self">About</a></li></ul></nav></header><main class="post"><article class="content"><div class="hero hero--noimage"><header class="hero__content"><div class="wrapper"><h1>无需公网IP: 通过Cloudflare Tunnels实现SSH安全内网穿透</h1><div class="feed__meta content__meta"><img src="https://blog.merack.top/media/website/qbanjinmuyan_Kan-Tu-Wang.web-2.png" loading="eager" height="500" width="458" class="feed__author-thumb" alt="Merack"> <a href="https://blog.merack.top/authors/merack/" class="feed__author">Merack</a> <time datetime="2025-02-28T23:58" class="feed__date">February 28, 2025</time></div></div></header></div><div class="entry-wrapper content__entry"><p>大善人Cloudflare在zero trust的网络里提供了一个叫做Tunnels的东西, 通过它可以很轻松地建立多条连接到cloudflare 网络的隧道. Tunnels提供了多种常见协议支持, 比如HTTP, HTTPS, TCP, SSH, RDP, SMB等, 甚至还支持与本地Unix socket文件通信. 本文主要以SSH为例介绍Tunnels的用法(其他协议也大同小异), 可以用于以下场景:</p><ul><li>在没有公网ip的情况下实现内网穿透SSH连接内网机器</li><li>在没有ipv6的环境下连接只有ipv6 ip的主机</li><li>远程主机到本地的线路质量很差, 丢包严重造成SSH操作卡顿, 通过tunnels传输SSH来缓解</li></ul><figure class="alignnone size-full wp-image-142">我这里以第一种场景为例, 内网中的主机是ubuntu 24.04.2 在后文我会把它称作服务端, 远程连接改服务端的pc是win 10, 后文我会称作客户端. 简单的原理图如下: <a href="https://cdn.merack.top/wp-content/uploads/2025/02/5566048f-e95e-5867-88a8-a3e59fcc811b.png"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/02/5566048f-e95e-5867-88a8-a3e59fcc811b.png" alt="" width="822" height="404" data-is-external-image="true"></a></figure><p></p><h2>准备工作</h2><ul><li>一个NS解析在cloudflare的域名</li><li>开通zero trust. zero trust的基础功能的免费的, 包括Tunnels, 但是需要绑定一个支付方式开通, 支持visa信用卡或者PayPal, 这里推荐PayPal, 因为PayPal可以绑定国内的银联卡, 无需信用卡.</li></ul><h2>创建Cloudflare Tunnels</h2><figure class="alignnone wp-image-143">登录Cloudflare控制台,然后进入页面左侧的Zero Trust → 网络→ Tunnels → 创建隧道。 隧道类型选择<strong>cloudflared</strong>, 自定义隧道名称（这里我以localSSH为例）。 <a href="https://cdn.merack.top/wp-content/uploads/2025/02/4a47a0db-6e60-853d-edfc-fdf08a5ca249.png"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/02/4a47a0db-6e60-853d-edfc-fdf08a5ca249.png" alt="" width="787" height="397" data-is-external-image="true"></a></figure><p></p><h2><a href="https://cdn.merack.top/wp-content/uploads/2025/02/2c280a13-e230-0dea-97f9-5fc4e98f81b4.png"><figure class="alignnone size-full wp-image-144"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/02/2c280a13-e230-0dea-97f9-5fc4e98f81b4.png" alt="" width="1820" height="645" data-is-external-image="true"></figure></a></h2><h2>安装Cloudflared</h2><figure class="alignnone size-full wp-image-145">接下来会进入到cloudflared的安装指导页面, cloudflared是隧道的创建和连接客户端, 选择适合服务端的架构, 这里我是ubuntu, 所以选的是Debian, 64bit. 复制知道页面的命令在服务端运行, 这些命令运行后会创建一个开机自启Systemd服务以确保隧道的时刻可用性. <a href="https://cdn.merack.top/wp-content/uploads/2025/02/0e4159f4-3c21-5fb0-5769-c98db8008f07.png"><img src="https://cdn.merack.top/wp-content/uploads/2025/02/0e4159f4-3c21-5fb0-5769-c98db8008f07.png" alt="" width="1301" height="788" data-is-external-image="true"></a></figure><a href="https://cdn.merack.top/wp-content/uploads/2025/02/db16ac4c-ce4d-7374-ffdb-91102fa0419f.png"><figure class="alignnone size-full wp-image-147"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/02/db16ac4c-ce4d-7374-ffdb-91102fa0419f.png" alt="" width="868" height="234" data-is-external-image="true"></figure></a>同时客户端也需要下载cloudflared, 因为前面说过cloudflared同时也是连接器. 可以在同一个页面选择客户端的架构版本下载, 但是不要运行后面的<code>cloudflared service install</code> , 这个命令只有服务端需要运行.也可以在cloudflared的官方仓库下载各个版本的文件: <a href="https://github.com/cloudflare/cloudflared/releases/">https://github.com/cloudflare/cloudflared/releases/</a><p></p><h2>路由隧道</h2><figure class="alignnone size-full wp-image-149">点击完成后在这个页面填写协议, ip, 端口, 并为该隧道分配一个子域名用于连接, ip填127.0.0.1, 建议不要填localhost, 可能会不成功. 如果服务器是只有ipv6的情况下填127.0.0.1可能无法连接, 需要填[::1]. 点击完成后cloudflare会自动创建dns记录, 下面就可以测试连接了. <a href="https://cdn.merack.top/wp-content/uploads/2025/02/7f9dcfd8-1d53-75c0-893a-dea0d5b51525.png"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/02/7f9dcfd8-1d53-75c0-893a-dea0d5b51525.png" alt="" width="1445" height="585" data-is-external-image="true"></a></figure><p></p><h2><a href="https://cdn.merack.top/wp-content/uploads/2025/02/1ddc25b1-517e-f30b-6182-3b6287aaa0b8.png"><figure class="alignnone size-full wp-image-150"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/02/1ddc25b1-517e-f30b-6182-3b6287aaa0b8.png" alt="" width="1346" height="45" data-is-external-image="true"></figure></a></h2><h2>连接测试</h2><p>接下来通过ssh 的ProxyCommand 来让cloudflared把我们的ssh流量转发到隧道中:</p><pre class="EnlighterJSRAW" data-enlighter-language="ini">ssh -o ProxyCommand="E:\code\go\bin\cloudflared access ssh --hostname localssh.merack.top" root@localssh.merack.top</pre><figure class="alignnone size-full wp-image-148"><a href="https://cdn.merack.top/wp-content/uploads/2025/02/1bd04439-445c-9796-d421-ec63d74df98c.png"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/02/1bd04439-445c-9796-d421-ec63d74df98c.png" alt="" width="1257" height="172" data-is-external-image="true"></a></figure>cloudflared 的路径, 用户名, host都换成自己的. 如果嫌每次都要写这么长的命令麻烦, 那么可以将其配置到ssh的配置文件里, 在windows下是 <code>C:\Users\&lt;User&gt;\.ssh\config</code>文件(&lt;User&gt;替换为自己windows上的用户名)<p></p><pre class="EnlighterJSRAW" data-enlighter-language="ini">Host localssh
    User root
    HostName localssh.merack.top
    ProxyCommand E:\code\go\bin\cloudflared access ssh --hostname %h</pre><figure class="alignnone size-full wp-image-151"><a href="https://cdn.merack.top/wp-content/uploads/2025/02/cda78973-308e-404f-bbbf-1f6340df4690.png"><img src="https://cdn.merack.top/wp-content/uploads/2025/02/cda78973-308e-404f-bbbf-1f6340df4690.png" alt="" width="1063" height="228" data-is-external-image="true"></a></figure>这时我们只需要在命令行里输入 <code>ssh localssh</code> 即可 <a href="https://cdn.merack.top/wp-content/uploads/2025/02/14e8bf73-c584-f2f2-08ee-5ebd0ea94099.png"><figure class="alignnone size-full wp-image-152"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/02/14e8bf73-c584-f2f2-08ee-5ebd0ea94099.png" alt="" width="678" height="175" data-is-external-image="true"></figure></a>如果是通过公钥文件的方式连接, 只需再加一行 <code>IdentityFile</code> 配置就好:<p></p><pre class="EnlighterJSRAW" data-enlighter-language="ini">Host localssh
    User root
    HostName localssh.merack.top
    ProxyCommand E:\code\go\bin\cloudflared access ssh --hostname %h
    IdentityFile C:\path\to\.ssh\id_remote-ssh</pre><h2>扩展</h2><p>通过上面的操作已经可以完成通过对内网服务器的ssh连接.此外tunnels还可以与zero trust中的其他功能想配合. 比如通过zero trust中的Access我们可以创建一个在浏览器上进行ssh操作tunnel所连接的内网服务器的网页, 无需写任何代码即可完成.下面进行简单的演示.</p><h3>搭建网页版ssh控制台并配置访问策略</h3><figure class="alignnone size-full wp-image-153">为了方便演示, 我又在上文的localssh tunnels里配置了一个用于web ssh的公共访问域名: localpanel.merack.top <a href="https://cdn.merack.top/wp-content/uploads/2025/02/136a3288-c45f-b14e-ee91-0e926c4ee165.png"><img src="https://cdn.merack.top/wp-content/uploads/2025/02/136a3288-c45f-b14e-ee91-0e926c4ee165.png" alt="" width="1454" height="430" data-is-external-image="true"></a></figure>登录Cloudflare控制台,然后进入页面左侧的Zero Trust → Access→ 应用程序→ 创建一个应用程序 应用程序类型选择<strong>自托管</strong>, 公共主机名设置成我们上面的localpanel.merack.top <a href="https://cdn.merack.top/wp-content/uploads/2025/02/2237c155-dabc-96cc-23d0-848898dcb0d1.png"><figure class="alignnone size-full wp-image-154"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/02/2237c155-dabc-96cc-23d0-848898dcb0d1.png" alt="" width="1744" height="729" data-is-external-image="true"></figure></a><a href="https://cdn.merack.top/wp-content/uploads/2025/02/40fcceaa-b6f0-3887-8e25-934a00e92838.png"><figure class="alignnone size-full wp-image-155"><img src="https://cdn.merack.top/wp-content/uploads/2025/02/40fcceaa-b6f0-3887-8e25-934a00e92838.png" alt="" width="1433" height="734" data-is-external-image="true"></figure></a>为了确保只能我们自己访问, 在页面下方我们新建一个访问策略 <a href="https://cdn.merack.top/wp-content/uploads/2025/02/ace8a9e5-5b49-3b04-0331-154f774657c0.png"><figure class="alignnone size-full wp-image-156"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/02/ace8a9e5-5b49-3b04-0331-154f774657c0.png" alt="" width="1422" height="361" data-is-external-image="true"></figure></a>访问策略里提供了相当多的规则, 这里我就选择emails, 表示只有规定的邮件地址才能进行验证, 然后在后方输入我们用于验证的email, 可以是多个, 可以不是注册cloudflare的邮箱. <a href="https://cdn.merack.top/wp-content/uploads/2025/02/034dcc47-bbda-f36e-7f5e-ccd61d6a2e28.png"><figure class="alignnone wp-image-157"><img src="https://cdn.merack.top/wp-content/uploads/2025/02/034dcc47-bbda-f36e-7f5e-ccd61d6a2e28.png" alt="" width="803" height="350" data-is-external-image="true"></figure></a>添加完访问策略后回到应用程序配置页面进行选择 <a href="https://cdn.merack.top/wp-content/uploads/2025/02/f8e328ec-b7a8-8050-cdd4-4c67c8a1b746.png"><figure class="alignnone size-full wp-image-158"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/02/f8e328ec-b7a8-8050-cdd4-4c67c8a1b746.png" alt="" width="1428" height="323" data-is-external-image="true"></figure></a>然后一直点击下一步来到高级设置, 打开浏览器呈现 <a href="https://cdn.merack.top/wp-content/uploads/2025/02/cabdd2ab-1c03-d022-c13d-b2790311bb27.png"><figure class="alignnone wp-image-159"><img src="https://cdn.merack.top/wp-content/uploads/2025/02/cabdd2ab-1c03-d022-c13d-b2790311bb27.png" alt="" width="768" height="570" data-is-external-image="true"></figure></a>这里是设置告诉cloudflare渲染什么样的界面, 有vnc和ssh, 这里我们选择ssh <a href="https://cdn.merack.top/wp-content/uploads/2025/02/4be9ab49-c0ed-6e11-ee61-b982676a78a6.png"><figure class="alignnone size-full wp-image-160"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/02/4be9ab49-c0ed-6e11-ee61-b982676a78a6.png" alt="" width="801" height="463" data-is-external-image="true"></figure></a>点击完成后web ssh应用程序就完成了, 这时我们打开为应用程序配置的公共域名localpanel.merack.top就会自动跳转到cloudflare access的验证页面, 这里只有填入我们刚才在访问策略里配置的邮箱地址才能收到cloudflare access的验证码 <a href="https://cdn.merack.top/wp-content/uploads/2025/02/ac556357-4b41-4b28-714a-1a50ca8b7d92.png"><figure class="alignnone wp-image-161"><img src="https://cdn.merack.top/wp-content/uploads/2025/02/ac556357-4b41-4b28-714a-1a50ca8b7d92.png" alt="" width="698" height="607" data-is-external-image="true"></figure></a>验证完后就可以在浏览器中对内网服务器进行ssh操作了. <a href="https://cdn.merack.top/wp-content/uploads/2025/02/f333e931-b0ea-bd89-514f-34bddadc5db3.png"><figure class="alignnone size-full wp-image-166"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/02/f333e931-b0ea-bd89-514f-34bddadc5db3.png" alt="" width="728" height="304" data-is-external-image="true"></figure></a>此外访问策略也可用于上文提到的用ssh 命令行连接的方式, cloudflared会自动在浏览器拉起验证页面<p></p><h3>优选IP加速访问</h3><figure class="alignnone size-full wp-image-162">cloudflare tunnels是建立在cloudflare的全球cdn节点上的, 但是cloudflare为ssh连接域名分配的默认泛播ip在国内体验不太好, 为了提升tunnels的连接体验, 我们可以手动修改hosts文件让ssh公共连接域名使用优选的ip节点. cloudflare优选ip网上的教程有很多, 最简单的就是直接ping我的博客域名: www.merack.top, 我的博客使用了SaaS, 这个域名会根据不同运营商返回优选好的ip. <a href="https://cdn.merack.top/wp-content/uploads/2025/02/865245cc-4d43-15d3-9be7-679b98cfade3.png"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/02/865245cc-4d43-15d3-9be7-679b98cfade3.png" alt="" width="615" height="176" data-is-external-image="true"></a></figure>比如windows上的hosts文件在C:\Windows\System32\drivers\etc\hosts, 那么我们可以做如下修改:<p></p><figure class="alignnone size-full wp-image-163"><a href="https://cdn.merack.top/wp-content/uploads/2025/02/6d4f2dc3-4db8-44c6-0d8b-ed0db2497af8.png"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/02/6d4f2dc3-4db8-44c6-0d8b-ed0db2497af8.png" alt="" width="606" height="235" data-is-external-image="true"></a></figure><p></p><p>保存好后重新进行连接应该体验会有所改善</p><h2>限制</h2><figure class="alignnone size-full wp-image-164">因为在服务端ssh连接是通过的本地cloudflared, 所以ssh server看到的连接ip都是来自127.0.0.1, 那么像 <a href="https://github.com/fail2ban/fail2ban">fail2ban</a> 这种基于连接ip的工具可能会失去其效果. <a href="https://cdn.merack.top/wp-content/uploads/2025/02/5d828a3b-88e1-07a7-04e9-ca18e57be167.png"><img src="https://cdn.merack.top/wp-content/uploads/2025/02/5d828a3b-88e1-07a7-04e9-ca18e57be167.png" alt="" width="605" height="143" data-is-external-image="true"></a></figure>但是可以通过配合zero trust里的访问策略来对密码爆破做一定限制, 比如可以配置一个与前文提到的网页版ssh的同款访问策略, 那么在你使用ssh命令连接时, cloudflared会自动拉起浏览器打开cloudflare access验证窗口, 通过验证后才能进行后续的操作. <a href="https://cdn.merack.top/wp-content/uploads/2025/02/6c86edfb-c156-2ff2-26c9-de606c714f19.png"><figure class="alignnone size-full wp-image-165"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/02/6c86edfb-c156-2ff2-26c9-de606c714f19.png" alt="" width="1220" height="265" data-is-external-image="true"></figure></a><p></p></div><footer class="content__footer"><div class="entry-wrapper"><div class="content__actions"></div></div><nav class="content__nav"><div class="wrapper"><div class="content__nav-inner"><div class="content__nav-prev"><a href="https://blog.merack.top/windowsmingw-w64lsp-clangdvscodesublime-pei-zhi-jian-dan-ccpp-dan-wen-jian-xue-xi-huan-jing-jian-yao-ji-lu.html" class="content__nav-link" rel="prev"><div><span>Previous</span> Windows+MinGW-w64+lsp-clangd+VSCode/sublime 配置简单c/cpp 单文件学习环境简要记录</div></a></div></div></div></nav></footer></article></main><footer class="footer"><div class="wrapper"><div class="footer__copyright"><p>Powered by Publii</p><div style="flex; align-items: center; justify-content: center;"><a href="https://cloudflare.com/"><img src="https://cdn.merack.top/wp-content/uploads/2024/12/ae2e8d68-158b-1842-fc34-0ebcc1365d6c.png" alt="cloudflare"> </a><a href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral"><img style="margin-right: 1px; vertical-align: middle;" src="https://cdn.merack.top/wp-content/uploads/2024/12/8a9de8d6-7a3c-e553-b074-cf653f15d712.png" alt="upyun"> </a><a href="https://cloudflare.com/">提供CDN服务</a></div></div><button onclick="backToTopFunction()" id="backToTop" class="footer__bttop" aria-label="Back to top" title="Back to top"><svg width="20" height="20"><use xlink:href="https://blog.merack.top/assets/svg/svg-map.svg#toparrow"/></svg></button></div></footer><script defer="defer" src="https://blog.merack.top/assets/js/scripts.min.js"></script><script>window.publiiThemeMenuConfig={mobileMenuMode:'overlay',animationSpeed:300,submenuWidth: 'auto',doubleClickTime:500,mobileMenuExpandableSubmenus:true,relatedContainerForOverlayMenuSelector:'.top'};</script><script>var images = document.querySelectorAll('img[loading]');
        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script></body></html>