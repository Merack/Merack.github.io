<!DOCTYPE html><html lang="en-gb"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>使用Cloudflare worker加速Cloudflare R2访问速度 - Merack&#x27;s Home</title><meta name="description" content="cloudflare R2 提供了免费10G的对象存储并且兼容Amazon S3 api 操作, 与大多数对象存储提供商不一样的是R2的流出流量是免费的, 不用担心请求被恶意刷爆第二天银行来收房子的情况发生. 但是cloudflare给R2分配的ip都是xxx.xxx.xxx.1形式的ip, 这种ip节点在国内的访问体验很不好,&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://blog.merack.top/shi-yong-cloudflare-workerjia-su-cloudflare-r2fang-wen-su-du.html"><link rel="alternate" type="application/atom+xml" href="https://blog.merack.top/feed.xml" title="Merack&#x27;s Home - RSS"><link rel="alternate" type="application/json" href="https://blog.merack.top/feed.json" title="Merack&#x27;s Home - JSON"><link rel="shortcut icon" href="https://blog.merack.top/media/website/favicon-16x16.png" type="image/png"><link rel="stylesheet" href="https://blog.merack.top/assets/css/style.css"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.merack.top/shi-yong-cloudflare-workerjia-su-cloudflare-r2fang-wen-su-du.html"},"headline":"使用Cloudflare worker加速Cloudflare R2访问速度","datePublished":"2025-03-17T01:50+08:00","dateModified":"2025-03-17T01:50+08:00","description":"cloudflare R2 提供了免费10G的对象存储并且兼容Amazon S3 api 操作, 与大多数对象存储提供商不一样的是R2的流出流量是免费的, 不用担心请求被恶意刷爆第二天银行来收房子的情况发生. 但是cloudflare给R2分配的ip都是xxx.xxx.xxx.1形式的ip, 这种ip节点在国内的访问体验很不好,&hellip;","author":{"@type":"Person","name":"Merack","url":"https://blog.merack.top/authors/merack/"},"publisher":{"@type":"Organization","name":"Merack"}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript></head><body class="post-template"><header class="top js-header"><a class="logo" href="https://blog.merack.top/">Merack&#x27;s Home</a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://blog.merack.top/about.html" target="_self">About</a></li></ul></nav></header><main class="post"><article class="content"><div class="hero hero--noimage"><header class="hero__content"><div class="wrapper"><h1>使用Cloudflare worker加速Cloudflare R2访问速度</h1><div class="feed__meta content__meta"><img src="https://blog.merack.top/media/website/qbanjinmuyan_Kan-Tu-Wang.web-2.png" loading="eager" height="500" width="458" class="feed__author-thumb" alt="Merack"> <a href="https://blog.merack.top/authors/merack/" class="feed__author">Merack</a> <time datetime="2025-03-17T01:50" class="feed__date">March 17, 2025</time></div></div></header></div><div class="entry-wrapper content__entry"><figure class="alignnone size-full wp-image-169">cloudflare R2 提供了免费10G的对象存储并且兼容Amazon S3 api 操作, 与大多数对象存储提供商不一样的是R2的流出流量是免费的, 不用担心请求被恶意刷爆第二天银行来收房子的情况发生. 但是cloudflare给R2分配的ip都是<strong>xxx.xxx.xxx.1</strong>形式的ip, 这种ip节点在国内的访问体验很不好, 特别是在移动网络下, 基本无法访问. <a href="https://cdn.merack.top/wp-content/uploads/2025/03/7a2f2732-8432-8240-5b2c-8e317f67adf3.png"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/03/7a2f2732-8432-8240-5b2c-8e317f67adf3.png" alt="" width="766" height="823" data-is-external-image="true"></a></figure>然而计算机领域里有句叫'没有什么问题是加一个中间层不能解决的', 而cloudflare里的worker刚好可以当这个'中间层'. worker是cloudflare提供的一个可以运行js/ts代码的serverless容器.<p></p><h2>设计原理</h2><figure class="alignnone size-full wp-image-179">我们无法更改cloudflare为R2分配的ip, 但是worker的路由我们是可以配置. 由此我们可以通过优选好的路由连接到worker, 然后让worker作为中间人去帮我们访问R2的资源, worker和r2同属于cloudflare网络, 它们之间的通信会非常快. 这样一来就能实现R2的'加速'访问. <a href="https://cdn.merack.top/wp-content/uploads/2025/03/78935e73-35ca-e855-23db-17a42b2a8c0d.png"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/03/78935e73-35ca-e855-23db-17a42b2a8c0d.png" alt="" width="636" height="276" data-is-external-image="true"></a></figure>本篇文章演示中R2绑定的访问域名是<strong>static.merack.top</strong>, worker通过worker路由绑定的域名是<strong>cdn.merack.top</strong>. 其中cdn.merack.top是最终给用户看到的域名. 用户向cdn.merack.top发出请求调用worker, worker请求R2: static.merack.top, 将R2的数据返回给用户.<p></p><h2>创建worker</h2><figure class="alignnone size-full wp-image-170">点击左侧workers和pages, 新建一个hello world 的worker, 不用选其他模板. <a href="https://cdn.merack.top/wp-content/uploads/2025/03/e6015d68-3116-04a4-94a0-b208e0e802dd.png"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/03/e6015d68-3116-04a4-94a0-b208e0e802dd.png" alt="" width="798" height="423" data-is-external-image="true"></a></figure>然后点击右上角的编辑代码按钮修改为如下代码<p></p><pre class="EnlighterJSRAW" data-enlighter-language="js">const R2_DOMAIN = 'static.merack.top'; // 改成自己的R2公共访问域名

async function handleRequest(request) {
  try {
    const url = new URL(request.url);
    
    // 构建新的R2资源URL
    const targetUrl = new URL(`https://${R2_DOMAIN}`);
    targetUrl.pathname = url.pathname;
    targetUrl.search = url.search;

    // 复制并修改请求头
    const headers = new Headers(request.headers);
    headers.set('Host', R2_DOMAIN);
    headers.delete('Cookie'); // 移除不必要的cookie头

    // 创建新请求
    const newRequest = new Request(targetUrl, {
      method: request.method,
      headers: headers,
      redirect: 'follow'
    });

    let response = await fetch(newRequest);
    return response;
  } catch (err) {
    // 错误处理
    return new Response(err.stack, { 
      status: 500,
      headers: { 'Content-Type': 'text/plain' }
    });
  }
}

// 监听所有请求
addEventListener('fetch', event =&gt; {
  event.respondWith(handleRequest(event.request));
});</pre><p><code>R2_DOMAIN</code> 常量改成自己的R2公共访问域名, 比如我这里是static.merack.top, 然后点击部署</p><h2>配置worker路由</h2><figure class="alignnone size-full wp-image-177">点击设置-&gt;域和路由, 点击右上方的添加按钮, 类型选择<strong>路由</strong> <a href="https://cdn.merack.top/wp-content/uploads/2025/03/49676e52-e8e6-e7b1-f1ee-5dfadc0517a0.png"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/03/49676e52-e8e6-e7b1-f1ee-5dfadc0517a0.png" alt="" width="490" height="466" data-is-external-image="true"></a></figure><p></p><figure class="alignnone size-full wp-image-178">接下来填入需要面向用户的那个域名, 路径填/*, 例如我这里填的就是<strong>cdn.merack.top/* </strong><a href="https://cdn.merack.top/wp-content/uploads/2025/03/5ec85094-a28c-82db-e8e1-fa001a47ecd2-1.png"><img src="https://cdn.merack.top/wp-content/uploads/2025/03/5ec85094-a28c-82db-e8e1-fa001a47ecd2-1.png" alt="" width="1249" height="480" data-is-external-image="true"></a></figure>这样用户访问cdn.merack.top时就触发worker去代理请求到R2, 但是此时还并不是优选的路由, 我们还需要修改下DNS解析 添加DNS记录让cdn.merack.top指向优选好的cloudflare cdn节点ip, 关于cf如何优选ip网上有很多教程就不赘述了, 图方便的话可以直接添加一个<strong>cname</strong>记录到别人的优选域名, 这里我用的是 <strong>cloudflare.182682.xyz</strong> , 也可以填我的博客域名<strong>www.merack.top</strong> , 但是注意后面的小黄云记得关闭, 让其状态为 '仅DNS' 模式, 这样你的cname才有意义. <a href="https://cdn.merack.top/wp-content/uploads/2025/03/2a8003ad-6428-d0c1-fda8-b9ccf732b974.png"><figure class="alignnone size-full wp-image-180"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/03/2a8003ad-6428-d0c1-fda8-b9ccf732b974.png" alt="" width="1345" height="154" data-is-external-image="true"></figure></a>点击保存后就可以将我们的访问域名换成worker路由的域名看看效果了.<p></p><h2>测试</h2><figure class="alignnone size-full wp-image-172">经过一番折腾后效果对比以前有了很大提升, 但还是有些地区无法正常访问, 这取决于当地的网络状况和优选ip的质量. 如果要做到100%的可用性的话, 建议还是花点钱买个好点的服务, 比如Amazon S3 + Amazon Cloudfont, 如果你的域名有备案, 国内云服务商提供的对象存储也是不错的选择. <a href="https://cdn.merack.top/wp-content/uploads/2025/03/8875d1e9-91f1-ff21-1ff6-c344b2b64688.png"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/03/8875d1e9-91f1-ff21-1ff6-c344b2b64688.png" alt="" width="748" height="812" data-is-external-image="true"></a></figure><p></p><h2>限制</h2><figure class="alignnone size-full wp-image-174">这个方案的限制主要来自worker. worker的免费订阅最关键的两个限制是CPU时间和日请求额度. <a href="https://cdn.merack.top/wp-content/uploads/2025/03/4394b2a9-0352-0851-da1d-1b706ac235d8.png"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/03/4394b2a9-0352-0851-da1d-1b706ac235d8.png" alt="" width="452" height="436" data-is-external-image="true"></a></figure><p></p><ol><li>每个请求的CPU时间是10毫秒, 超过这个时间请求会中断, 因此该方案不适用于大文件下载, 下到一半会中断. 10ms的时间最多能下到多大的文件没有测试过, 我用来请求存储本博客图片资源的R2的中值CPU时间不到1ms, 如果只是用作图片类型的文件加速, 10ms绰绰有余.</li><li>worker的每日请求是十万, 因此该方案只能适用于日访问量在万级以下的小博客. 如果你的日访问量都到万级以上了, 应该不缺那点小钱去买个好点存储和cdn了吧. 为了防止脚本恶意刷请求, 可以配合cloudflare waf里的速率限制规格做一定的限制, 关于cloudflare waf我之前有写过文章介绍. <a href="https://cdn.merack.top/wp-content/uploads/2025/03/83ccfc6c-c70d-a18e-b134-d350e18df4e5.png"><figure class="alignnone size-full wp-image-181"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/03/83ccfc6c-c70d-a18e-b134-d350e18df4e5.png" alt="" width="808" height="548" data-is-external-image="true"></figure></a></li></ol><h2>扩展</h2><figure class="alignnone size-full wp-image-173">1.本文例子中的使用场景是主要图片访问加速, 那么就会涉及到缓存时间的问题. worker返回的静态资源响应是会带有缓存控制的响应头(Cache-Control)的 <a href="https://cdn.merack.top/wp-content/uploads/2025/03/1821f6d1-320f-e877-4190-88014c4bfae4.png"><img loading="lazy" src="https://cdn.merack.top/wp-content/uploads/2025/03/1821f6d1-320f-e877-4190-88014c4bfae4.png" alt="" width="1288" height="389" data-is-external-image="true"></a></figure>如果你想修改缓存的过期时间, 可以使用worker的cache api来控制, 具体可以参照官方文档: <a href="https://developers.cloudflare.com/workers/runtime-apis/cache/">https://developers.cloudflare.com/workers/runtime-apis/cache/</a> <a href="https://developers.cloudflare.com/workers/reference/how-the-cache-works/">https://developers.cloudflare.com/workers/reference/how-the-cache-works/</a> 2.虽说本文是以加速r2的访问为主题, 当也可用于加速其他的网站, 只要把代码中的 R2_DOMAIN 常量改改就可以做到. 但如果你代理的是某些版权意识比较看重的大公司的站点, 访问量大了他们可能会向cloudflare投诉, 认为你在进行'假冒官网', '欺骗用户'等欺诈行为, 那么cloudflare可能会封禁你的账号.<p></p></div><footer class="content__footer"><div class="entry-wrapper"><div class="content__actions"></div></div><nav class="content__nav"><div class="wrapper"><div class="content__nav-inner"><div class="content__nav-prev"><a href="https://blog.merack.top/wu-xu-gong-wang-ip-tong-guo-cloudflare-tunnelsshi-xian-sshan-quan-nei-wang-chuan-tou.html" class="content__nav-link" rel="prev"><div><span>Previous</span> 无需公网IP: 通过Cloudflare Tunnels实现SSH安全内网穿透</div></a></div></div></div></nav></footer></article></main><footer class="footer"><div class="wrapper"><div class="footer__copyright"><p>Powered by Publii</p><div style="flex; align-items: center; justify-content: center;"><a href="https://cloudflare.com/"><img src="https://cdn.merack.top/wp-content/uploads/2024/12/ae2e8d68-158b-1842-fc34-0ebcc1365d6c.png" alt="cloudflare"> </a><a href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral"><img style="margin-right: 1px; vertical-align: middle;" src="https://cdn.merack.top/wp-content/uploads/2024/12/8a9de8d6-7a3c-e553-b074-cf653f15d712.png" alt="upyun"> </a><a href="https://cloudflare.com/">提供CDN服务</a></div></div><button onclick="backToTopFunction()" id="backToTop" class="footer__bttop" aria-label="Back to top" title="Back to top"><svg width="20" height="20"><use xlink:href="https://blog.merack.top/assets/svg/svg-map.svg#toparrow"/></svg></button></div></footer><script defer="defer" src="https://blog.merack.top/assets/js/scripts.min.js"></script><script>window.publiiThemeMenuConfig={mobileMenuMode:'overlay',animationSpeed:300,submenuWidth: 'auto',doubleClickTime:500,mobileMenuExpandableSubmenus:true,relatedContainerForOverlayMenuSelector:'.top'};</script><script>var images = document.querySelectorAll('img[loading]');
        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script></body></html>